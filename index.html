<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DDO Builds</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1a1a2e;--bg2:#16213e;--bg3:#0f3460;
  --text:#e0e0e0;--text2:#a0a0b0;--accent:#e94560;
  --accent2:#533483;--gold:#d4a017;--card:#1e2a4a;
  --border:#2a3a5a;--green:#4caf50;--blue:#5c9ded;
}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--blue);text-decoration:none}
.header{background:var(--bg2);border-bottom:2px solid var(--accent);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}
.header h1{font-size:1.2rem;color:var(--gold);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header .back{display:none;background:none;border:none;color:var(--accent);font-size:1.4rem;cursor:pointer;padding:4px 8px;flex-shrink:0}
.header .back.show{display:block}
.container{max-width:800px;margin:0 auto;padding:12px}
.card-list{display:flex;flex-direction:column;gap:10px}
.build-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;transition:border-color .2s,transform .1s}
.build-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.build-card:active{transform:translateY(0)}
.build-card h2{font-size:1rem;color:var(--gold);margin-bottom:4px}
.build-card .meta{font-size:.85rem;color:var(--text2)}
.build-card .classes{font-size:.9rem;color:var(--blue);margin-top:4px}
.badge{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:10px;margin-left:8px}
.badge-lives{background:var(--accent2);color:var(--text)}
.badge-builds{background:var(--bg3);color:var(--blue)}
.badge-current{background:var(--green);color:#fff}
.loading{text-align:center;padding:40px;color:var(--text2)}
.loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error{text-align:center;padding:40px;color:var(--accent)}
.view{display:none}
.view.active{display:block}
.detail-header{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.detail-header h2{color:var(--gold);font-size:1.3rem;margin-bottom:8px}
.detail-header .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;font-size:.9rem}
.detail-header .info-grid .label{color:var(--text2)}
.detail-header .info-grid .value{color:var(--text)}
.detail-header .classes-summary{margin-top:10px;font-size:1rem;color:var(--blue);font-weight:600}
.section{background:var(--card);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden}
.section-header{padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none}
.section-header:hover{background:rgba(255,255,255,.03)}
.section-header h3{font-size:.95rem;color:var(--accent)}
.section-header .arrow{color:var(--text2);transition:transform .2s;font-size:.8rem}
.section-header .arrow.open{transform:rotate(90deg)}
.section-body{padding:0 14px 14px;display:none}
.section-body.open{display:block}
.feat-group{margin-bottom:10px}
.feat-group h4{font-size:.85rem;margin-bottom:4px;color:var(--gold)}
.feat-list{list-style:none;font-size:.85rem}
.feat-list li{padding:2px 0;color:var(--text)}
.feat-list .feat-type{color:var(--text2);font-size:.8rem;margin-left:6px}
.tree-name{color:var(--blue);font-size:.9rem;padding:3px 0}
.ability-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.ability-box{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center}
.ability-box .name{font-size:.75rem;color:var(--text2);text-transform:uppercase}
.ability-box .spend{font-size:1.1rem;font-weight:700;color:var(--gold)}
.ability-box .tome{font-size:.75rem;color:var(--green)}
.level-row{display:flex;align-items:baseline;gap:8px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.85rem}
.level-row:last-child{border-bottom:none}
.level-num{color:var(--text2);min-width:28px;font-size:.8rem}
.level-class{color:var(--blue);min-width:90px}
.level-feats{color:var(--text);flex:1}
.level-feats span{background:var(--bg2);padding:1px 6px;border-radius:3px;margin:1px 2px;display:inline-block;font-size:.8rem}
.skills-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:2px 16px;font-size:.85rem}
.skill-row{display:flex;justify-content:space-between;padding:2px 0}
.skill-name{color:var(--text2)}
.skill-val{color:var(--text);font-weight:500}
.levelup-row{display:flex;justify-content:space-between;padding:2px 0;font-size:.85rem}
.levelup-label{color:var(--text2)}
.levelup-val{color:var(--gold)}
.empty-msg{color:var(--text2);font-style:italic;font-size:.85rem;padding:4px 0}
</style>
</head>
<body>
<div class="header">
  <button class="back" id="backBtn" title="Back">&#8592;</button>
  <h1 id="headerTitle">DDO Builds</h1>
</div>
<div class="container">
  <div class="view active" id="fileListView">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top:12px">Loading builds...</p>
    </div>
    <div class="card-list" id="fileList"></div>
  </div>
  <div class="view" id="livesView">
    <div class="card-list" id="livesList"></div>
  </div>
  <div class="view" id="buildsView">
    <div class="card-list" id="buildsList"></div>
  </div>
  <div class="view" id="detailView"></div>
</div>
<script>
)V1"
// Part 2: JavaScript â€” navigation + file list + lives list
R"V2(const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
let buildFiles = [];
let buildCache = {};
let navStack = [];

function showView(id, title) {
  $$('.view').forEach(v => v.classList.remove('active'));
  $(id).classList.add('active');
  $('#headerTitle').textContent = title || 'DDO Builds';
  $('#backBtn').classList.toggle('show', navStack.length > 0);
  window.scrollTo(0, 0);
}

$('#backBtn').addEventListener('click', () => {
  if (navStack.length > 0) {
    const prev = navStack.pop();
    showView(prev.view, prev.title);
  }
});

async function init() {
  try {
    const resp = await fetch('builds.json');
    if (!resp.ok) throw new Error('Failed to load builds.json');
    const files = await resp.json();
    buildFiles = files.filter(f => f.endsWith('.DDOBuild'));
    renderFileList();
  } catch(e) {
    $('#loading').innerHTML = '<div class="error">Could not load builds.<br><small>' + e.message + '</small></div>';
  }
}

function renderFileList() {
  $('#loading').style.display = 'none';
  const listEl = $('#fileList');
  if (buildFiles.length === 0) {
    listEl.innerHTML = '<div class="empty-msg">No builds found.</div>';
    return;
  }
  const promises = buildFiles.map(async (file) => {
    try { return { file, xml: await fetchBuild(file) }; }
    catch(e) { return { file, error: e.message }; }
  });
  Promise.all(promises).then(results => {
    listEl.innerHTML = '';
    results.forEach(r => {
      const card = document.createElement('div');
      card.className = 'build-card';
      if (r.error) {
        card.innerHTML = '<h2>' + esc(cleanName(r.file)) + '</h2><div class="meta">Error loading</div>';
      } else {
        const lives = r.xml.querySelectorAll('Character > Life');
        const liveCount = lives.length;
        // Use first life for summary
        const life = lives[0];
        const name = life ? gt(life, 'Name') : '';
        const race = life ? gt(life, 'Race') : '';
        const firstBuild = life ? life.querySelector(':scope > Build') : null;
        const level = firstBuild ? gt(firstBuild, 'Level') : '?';
        const classLine = firstBuild ? getClassLine(firstBuild) : '';

        card.innerHTML = '<h2>' + esc(name || cleanName(r.file))
          + (liveCount > 1 ? '<span class="badge badge-lives">' + liveCount + ' lives</span>' : '')
          + '</h2>'
          + '<div class="meta">' + esc(race) + ' &middot; Level ' + esc(level) + '</div>'
          + '<div class="classes">' + esc(classLine) + '</div>';
        card.onclick = () => openFile(r.file, r.xml);
      }
      listEl.appendChild(card);
    });
  });
}

async function fetchBuild(file) {
  if (buildCache[file]) return buildCache[file];
  const resp = await fetch(file);
  if (!resp.ok) throw new Error('HTTP ' + resp.status);
  const text = await resp.text();
  const xml = new DOMParser().parseFromString(text, 'text/xml');
  buildCache[file] = xml;
  return xml;
}

function openFile(file, xml) {
  const lives = xml.querySelectorAll('Character > Life');
  if (lives.length === 0) return;
  if (lives.length === 1) {
    // Single life â€” check builds
    const life = lives[0];
    const builds = life.querySelectorAll(':scope > Build');
    if (builds.length <= 1) {
      // Single life, single build â€” straight to detail
      navStack.push({ view: '#fileListView', title: 'DDO Builds' });
      renderDetail(xml, life, builds[0] || life, file);
      showView('#detailView', gt(life, 'Name') || cleanName(file));
    } else {
      // Single life, multiple builds
      navStack.push({ view: '#fileListView', title: 'DDO Builds' });
      renderBuildsList(xml, life, builds, file);
      showView('#buildsView', gt(life, 'Name') || cleanName(file));
    }
  } else {
    // Multiple lives
    navStack.push({ view: '#fileListView', title: 'DDO Builds' });
    renderLivesList(xml, lives, file);
    showView('#livesView', cleanName(file));
  }
}

function renderLivesList(xml, lives, file) {
  const listEl = $('#livesList');
  listEl.innerHTML = '';
  for (let i = 0; i < lives.length; i++) {
    const life = lives[i];
    const name = gt(life, 'Name');
    const race = gt(life, 'Race');
    const builds = life.querySelectorAll(':scope > Build');
    const firstBuild = builds[0];
    const level = firstBuild ? gt(firstBuild, 'Level') : '?';
    const classLine = firstBuild ? getClassLine(firstBuild) : '';
    const label = name || (i === 0 ? 'Current Life' : 'Life ' + (i + 1));

    const card = document.createElement('div');
    card.className = 'build-card';
    card.innerHTML = '<h2>' + esc(label)
      + (i === 0 ? '<span class="badge badge-current">Current</span>' : '')
      + (builds.length > 1 ? '<span class="badge badge-builds">' + builds.length + ' builds</span>' : '')
      + '</h2>'
      + '<div class="meta">' + esc(race) + ' &middot; Level ' + esc(level) + '</div>'
      + '<div class="classes">' + esc(classLine) + '</div>';
    card.onclick = ((idx) => () => {
      const life = lives[idx];
      const builds = life.querySelectorAll(':scope > Build');
      const lifeName = gt(life, 'Name') || (idx === 0 ? 'Current Life' : 'Life ' + (idx + 1));
      if (builds.length <= 1) {
        navStack.push({ view: '#livesView', title: cleanName(file) });
        renderDetail(xml, life, builds[0] || life, file);
        showView('#detailView', lifeName);
      } else {
        navStack.push({ view: '#livesView', title: cleanName(file) });
        renderBuildsList(xml, life, builds, file);
        showView('#buildsView', lifeName);
      }
    })(i);
    listEl.appendChild(card);
  }
}

function renderBuildsList(xml, life, builds, file) {
  const listEl = $('#buildsList');
  listEl.innerHTML = '';
  const lifeName = gt(life, 'Name') || cleanName(file);
  const race = gt(life, 'Race');
  for (let i = 0; i < builds.length; i++) {
    const build = builds[i];
    const level = gt(build, 'Level');
    const classLine = getClassLine(build);
    const label = i === 0 ? 'Current Build' : 'Past Build ' + i;

    const card = document.createElement('div');
    card.className = 'build-card';
    card.innerHTML = '<h2>' + esc(label)
      + (i === 0 ? '<span class="badge badge-current">Current</span>' : '')
      + '</h2>'
      + '<div class="meta">' + esc(race) + ' &middot; Level ' + esc(level) + '</div>'
      + '<div class="classes">' + esc(classLine) + '</div>';
    card.onclick = ((idx) => () => {
      navStack.push({ view: '#buildsView', title: lifeName });
      renderDetail(xml, life, builds[idx], file);
      showView('#detailView', lifeName + ' â€” ' + (idx === 0 ? 'Current' : 'Build ' + (idx + 1)));
    })(i);
    listEl.appendChild(card);
  }
}

function getClassLine(build) {
  const levels = build.querySelectorAll('LevelTraining');
  const counts = {};
  const order = [];
  for (const lt of levels) {
    const cls = gt(lt, 'Class');
    if (!cls || cls === 'Epic' || cls === 'Legendary') continue;
    if (!counts[cls]) { counts[cls] = 0; order.push(cls); }
    counts[cls]++;
  }
  return order.map(c => c + ' ' + counts[c]).join(' / ');
}
)V2"
// Part 3: JavaScript â€” detail rendering
R"V3(function renderDetail(xml, life, build, file) {
  const char = xml.querySelector('Character');
  const name = gt(life, 'Name') || cleanName(file);
  const race = gt(life, 'Race');
  const alignment = gt(life, 'Alignment');
  const level = gt(build, 'Level');
  const classLine = getClassLine(build);

  let html = '';
  html += '<div class="detail-header">';
  html += '<h2>' + esc(name) + '</h2>';
  html += '<div class="info-grid">';
  html += '<span class="label">Race</span><span class="value">' + esc(race) + '</span>';
  html += '<span class="label">Alignment</span><span class="value">' + esc(alignment) + '</span>';
  html += '<span class="label">Level</span><span class="value">' + esc(level) + '</span>';
  html += '</div>';
  html += '<div class="classes-summary">' + esc(classLine) + '</div>';
  html += '</div>';

  html += makeSection('Ability Point Spend', () => {
    const spend = build.querySelector('AbilitySpend');
    if (!spend) return '<div class="empty-msg">No ability data</div>';
    const abs = [
      { n:'STR', s:'StrSpend', t:'StrTome' },
      { n:'DEX', s:'DexSpend', t:'DexTome' },
      { n:'CON', s:'ConSpend', t:'ConTome' },
      { n:'INT', s:'IntSpend', t:'IntTome' },
      { n:'WIS', s:'WisSpend', t:'WisTome' },
      { n:'CHA', s:'ChaSpend', t:'ChaTome' },
    ];
    const avail = gt(spend, 'AvailableSpend') || '?';
    let s = '<div style="font-size:.85rem;color:var(--text2);margin-bottom:8px">Point buy: ' + esc(avail) + '</div>';
    s += '<div class="ability-grid">';
    abs.forEach(a => {
      const pts = gt(spend, a.s) || '0';
      const tome = char ? gt(char, a.t) : '0';
      s += '<div class="ability-box"><div class="name">' + a.n + '</div><div class="spend">' + pts + '</div>';
      if (tome && tome !== '0') s += '<div class="tome">+' + tome + ' tome</div>';
      s += '</div>';
    });
    s += '</div>';
    return s;
  }, true);

  html += makeSection('Level-Up Ability Increases', () => {
    const lvls = [4,8,12,16,20,24,28,32,36,40];
    let s = '', any = false;
    lvls.forEach(lv => {
      const el = build.querySelector('Level' + lv);
      if (el && el.textContent) {
        any = true;
        s += '<div class="levelup-row"><span class="levelup-label">Level ' + lv + '</span><span class="levelup-val">' + esc(el.textContent) + '</span></div>';
      }
    });
    return any ? s : '<div class="empty-msg">None</div>';
  });

  html += makeSection('Level Progression', () => {
    const levels = build.querySelectorAll('LevelTraining');
    if (!levels.length) return '<div class="empty-msg">No level data</div>';
    let s = '', n = 1;
    for (const lt of levels) {
      const cls = gt(lt, 'Class');
      let fh = '';
      for (const f of lt.querySelectorAll('TrainedFeat')) {
        const fn = gt(f, 'FeatName'), ft = gt(f, 'Type');
        if (fn) fh += '<span title="' + esc(ft) + '">' + esc(fn) + '</span> ';
      }
      s += '<div class="level-row"><span class="level-num">' + n + '</span><span class="level-class">' + esc(cls) + '</span><span class="level-feats">' + fh + '</span></div>';
      n++;
    }
    return s;
  }, true);
)V3"
// Part 4: JavaScript â€” feats, trees, skills, helpers
R"V4(
  html += makeSection('All Feats by Type', () => {
    const groups = {};
    for (const lt of build.querySelectorAll('LevelTraining')) {
      for (const f of lt.querySelectorAll('TrainedFeat')) {
        const fn = gt(f,'FeatName'), ft = gt(f,'Type')||'Other', lv = gt(f,'LevelTrainedAt');
        if (!fn) continue;
        if (!groups[ft]) groups[ft] = [];
        groups[ft].push({ name:fn, level:lv });
      }
    }
    for (const f of life.querySelectorAll('SpecialFeats > TrainedFeat')) {
      const fn = gt(f,'FeatName'), ft = gt(f,'Type')||'Special';
      if (fn) { if (!groups[ft]) groups[ft] = []; groups[ft].push({ name:fn, level:'0' }); }
    }
    if (char) {
      for (const f of char.querySelectorAll(':scope > SpecialFeats > TrainedFeat')) {
        const fn = gt(f,'FeatName'), ft = gt(f,'Type')||'Special';
        if (!fn) continue;
        if (!groups[ft]) groups[ft] = [];
        if (!groups[ft].some(x => x.name === fn)) groups[ft].push({ name:fn, level:'0' });
      }
    }
    if (!Object.keys(groups).length) return '<div class="empty-msg">No feats</div>';
    let s = '';
    const types = Object.keys(groups).sort((a,b) => a==='Standard'?-1:b==='Standard'?1:a.localeCompare(b));
    for (const type of types) {
      s += '<div class="feat-group"><h4>' + esc(type) + '</h4><ul class="feat-list">';
      groups[type].forEach(f => {
        const li = (f.level && f.level !== '0') ? ' (Lv ' + f.level + ')' : '';
        s += '<li>' + esc(f.name) + '<span class="feat-type">' + esc(li) + '</span></li>';
      });
      s += '</ul></div>';
    }
    return s;
  });

  html += makeSection('Enhancement Trees', () => {
    let s = '';
    for (const t of build.querySelectorAll('Enhancement_SelectedTrees > TreeName'))
      if (t.textContent && t.textContent !== 'No selection') s += '<div class="tree-name">' + esc(t.textContent) + '</div>';
    return s || '<div class="empty-msg">None selected</div>';
  }, true);

  html += makeSection('Epic Destiny Trees', () => {
    let s = '';
    for (const t of build.querySelectorAll('Destiny_SelectedTrees > TreeName'))
      if (t.textContent && t.textContent !== 'No selection') s += '<div class="tree-name">' + esc(t.textContent) + '</div>';
    return s || '<div class="empty-msg">None selected</div>';
  });

  html += makeSection('Reaper Trees', () => {
    let s = '';
    for (const t of build.querySelectorAll('Reaper_SelectedTrees > TreeName'))
      if (t.textContent && t.textContent !== 'No selection') s += '<div class="tree-name">' + esc(t.textContent) + '</div>';
    return s || '<div class="empty-msg">None selected</div>';
  });

  html += makeSection('Skills (Total Ranks Trained)', () => {
    const skills = {};
    for (const lt of build.querySelectorAll('LevelTraining'))
      for (const ts of lt.querySelectorAll('TrainedSkill')) {
        const sk = gt(ts,'Skill');
        if (sk) skills[sk] = (skills[sk]||0) + 1;
      }
    if (!Object.keys(skills).length) return '<div class="empty-msg">No skills trained</div>';
    let s = '<div class="skills-grid">';
    Object.entries(skills).sort((a,b) => b[1]-a[1]).forEach(([n,c]) => {
      s += '<div class="skill-row"><span class="skill-name">' + esc(n) + '</span><span class="skill-val">' + c + '</span></div>';
    });
    return s + '</div>';
  });

  $('#detailView').innerHTML = html;
  $$('.section-header').forEach(h => {
    h.addEventListener('click', () => {
      h.nextElementSibling.classList.toggle('open');
      h.querySelector('.arrow').classList.toggle('open');
    });
  });
}

function makeSection(title, fn, open) {
  const c = fn(), o = open ? ' open' : '';
  return '<div class="section"><div class="section-header"><h3>' + esc(title) + '</h3><span class="arrow' + o + '">&#9654;</span></div><div class="section-body' + o + '">' + c + '</div></div>';
}

function gt(p, t) {
  if (!p) return '';
  const el = p.querySelector(':scope > ' + t);
  return el ? el.textContent.trim() : '';
}
function cleanName(f) { return f.replace(/\.DDOBuild$/i, ''); }
function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }

window.addEventListener('popstate', () => { if (navStack.length) $('#backBtn').click(); });
init();
</script>
</body>
</html>
